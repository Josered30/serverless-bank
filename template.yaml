AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  bank

  Sample SAM Template for Bank app

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 3
    MemorySize: 128

Resources:
  UserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: users
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  UserCreditsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: user_credits
      AttributeDefinitions:
        - AttributeName: user
          AttributeType: S
      KeySchema:
        - AttributeName: user
          KeyType: "HASH"
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1

  TransactionEventsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: transaction_events
      AttributeDefinitions:
        - AttributeName: source
          AttributeType: S
        - AttributeName: id
          AttributeType: N
      KeySchema:
        - AttributeName: source
          KeyType: "HASH"
        - AttributeName: id
          KeyType: "RANGE"
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      GlobalSecondaryIndexes:
        - IndexName: by-source
          KeySchema:
            - AttributeName: source
              KeyType: "HASH"
          Projection:
            ProjectionType: "ALL"
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1

  ExecutePaymentFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Metadata:
      BuildMethod: rust-cargolambda # More info about Cargo Lambda: https://github.com/cargo-lambda/cargo-lambda
    Properties:
      FunctionName: ExecutePaymentFunction
      CodeUri: ./functions/execute_payments # Points to dir of Cargo.toml
      Handler: bootstrap # Do not change, as this is the default executable name produced by Cargo Lambda
      Runtime: provided.al2023
      Role: !GetAtt ExecutePaymentLambdaRole.Arn
      Architectures:
        - arm64
      Environment:
        Variables:
          TRANSACTION_EVENT_TABLE_NAME: !GetAtt TransactionEventsTable.Arn

  RequestPaymentFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Metadata:
      BuildMethod: rust-cargolambda # More info about Cargo Lambda: https://github.com/cargo-lambda/cargo-lambda
    Properties:
      FunctionName: RequestPaymentFunction
      CodeUri: ./functions/request_payments # Points to dir of Cargo.toml
      Handler: bootstrap # Do not change, as this is the default executable name produced by Cargo Lambda
      Runtime: provided.al2023
      Role: !GetAtt RequestPaymentLambdaRole.Arn
      Architectures:
        - arm64
      Environment:
        Variables:
          TRANSACTION_EVENT_TABLE_NAME: !GetAtt TransactionEventsTable.Arn

  AddCreditsFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Metadata:
      BuildMethod: rust-cargolambda # More info about Cargo Lambda: https://github.com/cargo-lambda/cargo-lambda
    Properties:
      FunctionName: AddCreditsFunction
      CodeUri: ./functions/add_credits # Points to dir of Cargo.toml
      Handler: bootstrap # Do not change, as this is the default executable name produced by Cargo Lambda
      Runtime: provided.al2023
      Role: !GetAtt AddCreditsLambdaRole.Arn
      Architectures:
        - arm64
      Environment:
        Variables:
          USER_CREDITS_TABLE_NAME: !GetAtt UserCreditsTable.Arn
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Method: post
            Path: /credits
            RestApiId: !Ref BankApi
    
  CreateUserFunction:
    Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
    Metadata:
      BuildMethod: rust-cargolambda # More info about Cargo Lambda: https://github.com/cargo-lambda/cargo-lambda
    Properties:
      FunctionName: CreateUserFunction
      CodeUri: ./functions/create_user # Points to dir of Cargo.toml
      Handler: bootstrap # Do not change, as this is the default executable name produced by Cargo Lambda
      Runtime: provided.al2023
      Role: !GetAtt CreateUserLambdaRole.Arn
      Architectures:
        - arm64
      Environment:
        Variables:
          USER_TABLE_NAME: !GetAtt UserTable.Arn
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Method: post
            Path: /users
            RestApiId: !Ref BankApi

  ExecuteTransactionSf:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: ExecuteTransactionSf
      DefinitionSubstitutions:
        UserTableArn: !GetAtt UserTable.Arn
        ExecutePaymentLambdaArn: !GetAtt ExecutePaymentFunction.Arn
        RequestPaymentLambdaArn: !GetAtt RequestPaymentFunction.Arn
      DefinitionUri: statemachine/post_transaction.json
      Role: !GetAtt ExecuteTransactionSfRole.Arn
      Type: EXPRESS
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ExecuteTransactionSfLogGroup.Arn
        IncludeExecutionData: true
        Level: "ALL"
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Method: post
            Path: /payments
            RestApiId: !Ref BankApi

  BankApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      DefinitionBody: # an OpenApi definition
        "Fn::Transform":
          Name: "AWS::Include"
          Parameters:
            Location: "openapi/openapi.yml"
      OpenApiVersion: 3.0.0
      EndpointConfiguration:
        Type: REGIONAL
    DependsOn: 
      - ExecuteTransactionSf
      - AddCreditsFunction

  ExecuteTransactionSfLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: ExecuteTransactionSfLogGroup

  ExecuteTransactionSfRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - states.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /

  RestApiRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - apigateway.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: AllowSFNExec
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: "states:StartSyncExecution"
                Resource: !GetAtt ExecuteTransactionSf.Arn

  ExecutePaymentLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  AddCreditsLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  CreateUserLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  RequestPaymentLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  DynamoDBPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "DynamoDBPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: "dynamodb:PutItem"
            Resource: !GetAtt TransactionEventsTable.Arn
          - Effect: Allow
            Action: 
              - "dynamodb:GetItem"
              - "dynamodb:PutItem"
            Resource: !GetAtt UserTable.Arn
          - Effect: Allow
            Action: "dynamodb:Query"
            Resource:
              - !GetAtt TransactionEventsTable.Arn
              - !Sub "${TransactionEventsTable.Arn}/index/*"
          - Effect: Allow
            Action: 
              - "dynamodb:GetItem"
              - "dynamodb:UpdateItem"
            Resource: !GetAtt UserCreditsTable.Arn
      Roles:
        - !Ref ExecutePaymentLambdaRole
        - !Ref RequestPaymentLambdaRole
        - !Ref AddCreditsLambdaRole
        - !Ref CreateUserLambdaRole
        - !Ref ExecuteTransactionSfRole

  InvokeLambdaPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "InvokeLambdaPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: "lambda:InvokeFunction"
            Resource:
              - !GetAtt ExecutePaymentFunction.Arn
              - !GetAtt RequestPaymentFunction.Arn
      Roles:
        - !Ref ExecuteTransactionSfRole

  CloudWatchPolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: "CloudWatchPolicy"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action:
              - "cloudwatch:*"
              - "logs:CreateLogDelivery"
              - "logs:CreateLogStream"
              - "logs:GetLogDelivery"
              - "logs:UpdateLogDelivery"
              - "logs:DeleteLogDelivery"
              - "logs:ListLogDeliveries"
              - "logs:PutLogEvents"
              - "logs:PutResourcePolicy"
              - "logs:DescribeResourcePolicies"
              - "logs:DescribeLogGroups"
            Resource: "*"
      Roles:
        - !Ref ExecuteTransactionSfRole

  ExecutePaymentRoleInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: "/"
      Roles:
        - !Ref ExecutePaymentLambdaRole

  RequestPaymentRoleInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: "/"
      Roles:
        - !Ref RequestPaymentLambdaRole
  
  AddCreditsRoleInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: "/"
      Roles:
        - !Ref AddCreditsLambdaRole

  CreateUserRoleInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      Path: "/"
      Roles:
        - !Ref CreateUserLambdaRole

Outputs:
  # ServerlessRestApi is an implicit API created out of Events key under Serverless::Function
  # Find out more about other implicit resources you can reference within SAM
  # https://github.com/awslabs/serverless-application-model/blob/master/docs/internals/generated_resources.rst#api
  ExecutePaymentFunctionOutput:
    Description: "Execute Payment Lambda Function ARN"
    Value: !GetAtt ExecutePaymentFunction.Arn
  RequestPaymentFunctionOutput:
    Description: "Request Payment Lambda Function ARN"
    Value: !GetAtt RequestPaymentFunction.Arn
  AddCreditsFunctionOutput:
    Description: "Add credits lambda Function ARN"
    Value: !GetAtt AddCreditsFunction.Arn
  CreateUserFunctionOutput:
    Description: "Create user lambda Function ARN"
    Value: !GetAtt CreateUserFunction.Arn
  ExecutePaymentStepFunctionOutput:
    Description: "Execute Payment Step Function ARN"
    Value: !GetAtt ExecuteTransactionSf.Arn
